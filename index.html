<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIBRVRY</title>

  <meta property="og:type" content="website">
  <meta property="og:title" content="LIBRVRY">
  <meta property="og:description" content="Be quiet">
  <meta property="og:image" content="https://librvry.com/favicon/social-card.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://librvry.com">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="LIBRVRY">
  <meta name="twitter:description" content="Be quiet">
  <meta name="twitter:image" content="https://librvry.com/favicon/social-card.png">

  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
  <link rel="shortcut icon" href="favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="LIBRVRY" />
  <link rel="manifest" href="favicon/site.webmanifest" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KQGX2CS3KF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KQGX2CS3KF');
  </script>

  <style>
    :root{
      color-scheme: light;
      --book-width: 300px;
      --bg: #D2D2D2;
      /* JS will set --vh to 1% of the true visible viewport height on mobile */
      --vh: 1vh;
    }

    html, body{
      height: 100%;
    }

    body{
      margin:0;
      min-height:100dvh;
      background: var(--bg);
      overflow:hidden;
      user-select:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .stage{
      position: relative;
      width: 100vw;

      /* Prefer modern dynamic viewport units */
      height: 100dvh;

      /* Fallback: JS-maintained viewport height */
      height: calc(var(--vh) * 100);

      touch-action: none;
      overscroll-behavior: none;
    }

    .logo-layer{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:0;
    }

    .logo-container{
      width:110px;
      height:auto;
      opacity:0;
      animation: logoFadeIn 0.8s ease-out forwards;
    }

    body.books-in .logo-container{
      opacity:0.18;
      transition: opacity 280ms ease-out;
    }

    .logo-container svg{
      width:100%;
      height:auto;
      display:block;
      overflow:visible;
    }

    .logo-clip-group{
      animation: removeClip 1ms linear 804ms forwards;
    }
    @keyframes removeClip { to { clip-path: none; } }

    .logo-book-1{ animation: bookSlideUp 200ms cubic-bezier(0.25, 0.1, 0.25, 1) 0ms both; }
    .logo-book-2{ animation: bookSlideUp 200ms cubic-bezier(0.25, 0.1, 0.25, 1) 201ms both; }
    .logo-book-3{ animation: bookSlideUp 200ms cubic-bezier(0.25, 0.1, 0.25, 1) 402ms both; }

    .logo-book-4-vertical{
      animation:
        bookSlideUp 200ms cubic-bezier(0.25, 0.1, 0.25, 1) 603ms both,
        hideInstant 1ms linear 1004ms both;
    }

    .logo-book-4-angled{
      opacity:0;
      transform-origin: 441px 191px;
      animation:
        showInstant 1ms linear 1004ms both,
        rotateFromVertical 800ms cubic-bezier(0.68, -0.55, 0.27, 1.55) 504ms both;
    }

    @keyframes hideInstant { to { opacity: 0; } }
    @keyframes showInstant { to { opacity: 1; } }

    @keyframes rotateFromVertical{
      from { transform: translateX(32px) rotate(-11.5deg); }
      to   { transform: translateX(0) rotate(0deg); }
    }

    @keyframes logoFadeIn { from { opacity:0; } to { opacity:1; } }
    @keyframes bookSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .book{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin:50% 90%;
      border-radius:0;
      overflow:visible;
      background:#FFFFFF;
      box-shadow:0 14px 40px rgba(0,0,0,0.18);
      will-change:transform;
      pointer-events:none;
      z-index:1;
    }

    .book img{
      width: var(--w, var(--book-width));
      max-width:100%;
      height:auto;
      display:block;
      pointer-events:none;
      -webkit-user-drag:none;
      user-drag:none;
    }

    @media (min-width: 768px){
      .logo-container{ width:147px; }
    }

    @media (prefers-reduced-motion: reduce){
      .logo-container,
      .logo-clip-group,
      .logo-book-1, .logo-book-2, .logo-book-3,
      .logo-book-4-vertical, .logo-book-4-angled{
        animation: none !important;
      }
      .book{ transition: none !important; }
    }
  </style>
</head>

<body>

  <div class="logo-layer">
    <div class="logo-container">
      <svg viewBox="0 0 701 382" fill="none" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <clipPath id="logo-clip">
            <rect x="0" y="0" width="701" height="382" />
          </clipPath>
        </defs>
        <g clip-path="url(#logo-clip)" class="logo-clip-group">
          <path class="logo-book-4-vertical" d="M573.29 23.66H441V382H573.29V23.66Z" fill="white" />
          <path class="logo-book-4-angled" d="M563.113 -0.000350202L441 50.8828L578.83 381.655L700.942 330.772L563.113 -0.000350202Z" fill="white" />
          <path class="logo-book-3" d="M425.96 23.66H293.67V382H425.96V23.66Z" fill="white" />
          <path class="logo-book-2" d="M279.12 23.66H146.83V382H279.12V23.66Z" fill="white" />
          <path class="logo-book-1" d="M132.29 23.66H0V382H132.29V23.66Z" fill="white" />
        </g>
      </svg>
    </div>
  </div>

  <div class="stage" id="stage" aria-label="Book cover stack animation"></div>

  <script>
(() => {
  const stage = document.getElementById("stage");

  // ---------- Tunables ----------
  const MAX_ONSCREEN = 14;
  const MIN_STACK = 6;

  const DEFAULT_AUTOPLAY_INTERVAL = 200; // ms
  const RESUME_AFTER_MS = 2200;

  const LOGO_ANIMATION_DELAY = 2500;

  const INTRO_STREAM_INTERVAL = 90;    // ms
  const INTRO_STREAM_DURATION = 1200;  // ms

  const OFFSCREEN = 1100;

  const MIN_W = 190;
  const MAX_W = 420;

  const SCALE_NATIVE = 0.75;

  // ---------- URL params ----------
  const params = new URLSearchParams(location.search);

  const autoplayRaw = (params.get("autoplay") || "").trim().toLowerCase();
  const AUTOPLAY =
    !(autoplayRaw === "0" || autoplayRaw === "false" || autoplayRaw === "off" || autoplayRaw === "no");

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function getAutoplayInterval(){
    if (autoplayRaw && !Number.isNaN(parseInt(autoplayRaw, 10))) {
      const ms = parseInt(autoplayRaw, 10);
      return clamp(ms, 50, 5000);
    }
    return DEFAULT_AUTOPLAY_INTERVAL;
  }

  const AUTOPLAY_INTERVAL = getAutoplayInterval();

  // ---------- State ----------
  let covers = [];
  let idx = 0;

  let autoplayTimer = null;
  let autoplayRampTimer = null;

  let booksReady = false;

  let lastUserInputAt = performance.now() + LOGO_ANIMATION_DELAY;
  function noteUserInput(){
    lastUserInputAt = performance.now();
  }

  // ---------- Viewport fix ----------
  function setViewportUnit(){
    const h = (window.visualViewport && window.visualViewport.height)
      ? window.visualViewport.height
      : window.innerHeight;
    document.documentElement.style.setProperty("--vh", (h * 0.01) + "px");
  }

  // ---------- Helpers ----------
  function hashToUnitFloat(str){
    let h = 2166136261;
    for (let i = 0; i < str.length; i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0) / 4294967296;
  }

  function baseRotationFor(src, maxDeg = 12){
    const u = hashToUnitFloat(src);
    return (u * 2 - 1) * maxDeg;
  }

  function randomEntryVector(dir = 0){
    if (dir === -1) return { x: -OFFSCREEN, y: (Math.random() * 600 - 300) };
    if (dir ===  1) return { x:  OFFSCREEN, y: (Math.random() * 600 - 300) };
    const angle = Math.random() * Math.PI * 2;
    return { x: Math.cos(angle) * OFFSCREEN, y: Math.sin(angle) * OFFSCREEN };
  }

  function getTargetWidthPx(){
    const w = Math.floor(window.innerWidth * 0.82);
    return clamp(w, MIN_W, MAX_W);
  }

  function setGlobalWidthVar(){
    const w = getTargetWidthPx();
    document.documentElement.style.setProperty("--book-width", w + "px");
    return w;
  }

  function nextCover(){
    if (covers.length === 0) return null;
    const src = covers[idx % covers.length];
    idx++;
    return src;
  }

  function computeCenterY(ar, widthPx){
    return ar ? (-(widthPx * ar) / 2) : 0;
  }

  function setTransform(el, x, y, rotDeg, scale, centerY){
    el.style.transform =
      `translate(-50%, ${centerY}px) translate(${x}px, ${y}px) rotate(${rotDeg}deg) scale(${scale})`;
  }

  function ensureStack(minCount = MIN_STACK){
    if (!covers.length || !booksReady) return;
    let count = stage.querySelectorAll(":scope > .book").length;
    while (count < minCount) {
      addBook({ animateIn: true, dir: 0, intro: false, delay: 0 });
      count++;
    }
  }

  function introStack(n = MIN_STACK){
    for (let i = 0; i < n; i++){
      addBook({ animateIn: true, dir: 0, intro: true, delay: i * 50 });
    }
  }

  // ---------- Core ----------
  async function loadCovers(){
    const res = await fetch("/covers.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`GET /covers.json failed: ${res.status}`);
    const list = await res.json();
    if (!Array.isArray(list) || list.length === 0) throw new Error("No covers found.");
    covers = list;

    setViewportUnit();
    setGlobalWidthVar();

    setTimeout(() => {
      booksReady = true;
      document.body.classList.add("books-in");

      lastUserInputAt = performance.now() - RESUME_AFTER_MS - 1;

      introStack(MIN_STACK);

      if (AUTOPLAY) {
        startAutoplay(INTRO_STREAM_INTERVAL);
        clearTimeout(autoplayRampTimer);
        autoplayRampTimer = setTimeout(() => startAutoplay(AUTOPLAY_INTERVAL), INTRO_STREAM_DURATION);
      }
    }, LOGO_ANIMATION_DELAY);
  }

  function addBook({ animateIn = true, dir = 0, intro = false, delay = 0 } = {}){
    if (!booksReady) return;

    const src = nextCover();
    if (!src) return;

    const book = document.createElement("div");
    book.className = "book";

    const rot = baseRotationFor(src, 12) + (Math.random() * 6 - 3);
    const scale = 1;

    const driftX = (Math.random() * 18 - 9);
    const driftY = (Math.random() * 10 - 5);

    const img = document.createElement("img");
    img.src = src;
    img.alt = "";
    img.draggable = false;

    book.appendChild(img);
    stage.appendChild(book);

    while (stage.querySelectorAll(":scope > .book").length > MAX_ONSCREEN) {
      const first = stage.querySelector(":scope > .book");
      if (first) first.remove();
      else break;
    }

    const entry = randomEntryVector(dir);

    const onLoaded = () => {
      const natW = img.naturalWidth || 0;
      const natH = img.naturalHeight || 0;
      const ar = (natW && natH) ? (natH / natW) : 0;

      const targetW = getTargetWidthPx();
      const maxNativeW = natW ? (natW * SCALE_NATIVE) : targetW;
      const clampedW = Math.min(targetW, maxNativeW);

      document.documentElement.style.setProperty("--book-width", targetW + "px");
      book.style.setProperty("--w", clampedW + "px");

      const centerY = computeCenterY(ar, clampedW);

      book.style.transition = "none";
      setTransform(book, entry.x + driftX, entry.y + driftY, rot, scale, centerY);
      void book.offsetWidth;

      const finalX = driftX;
      const finalY = driftY;

      const landX = finalX + (Math.random() * 10 - 5);
      const landY = finalY + (Math.random() * 8 + 10);
      const landRot = rot + (Math.random() * 6 - 3);

      if (book.animate) {
        const start = randomEntryVector(dir);
        const startBoost = intro ? 1.25 : 1.0;

        const fromX = (start.x + driftX) * startBoost;
        const fromY = (start.y + driftY) * startBoost;

        book.style.transition = "none";
        setTransform(book, fromX, fromY, rot, scale, centerY);

        book.animate(
          [
            { transform: `translate(-50%, ${centerY}px) translate(${fromX}px, ${fromY}px) rotate(${rot}deg) scale(${scale})` },
            { transform: `translate(-50%, ${centerY}px) translate(${landX}px, ${landY}px) rotate(${landRot}deg) scale(${scale})`, offset: 0.78 },
            { transform: `translate(-50%, ${centerY}px) translate(${finalX}px, ${finalY}px) rotate(${rot}deg) scale(${scale})` }
          ],
          {
            duration: intro ? 720 : 380,
            delay,
            easing: intro ? "cubic-bezier(.12,.86,.18,1)" : "cubic-bezier(.2,.85,.2,1)",
            fill: "both"
          }
        );

        setTransform(book, finalX, finalY, rot, scale, centerY);
      } else {
        book.style.transition = "transform 300ms cubic-bezier(.2,.85,.2,1)";
        setTransform(book, finalX, finalY, rot, scale, centerY);
      }
    };

    img.addEventListener("load", onLoaded, { once: true });
    img.addEventListener("error", () => book.remove(), { once: true });
    if (img.complete) onLoaded();

    if (!intro) ensureStack(MIN_STACK);
  }

  function startAutoplay(interval = AUTOPLAY_INTERVAL){
    clearInterval(autoplayTimer);
    autoplayTimer = setInterval(() => {
      const now = performance.now();
      if (now - lastUserInputAt < RESUME_AFTER_MS) return;
      addBook({ animateIn: true, dir: 0, intro: false, delay: 0 });
    }, interval);
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      clearInterval(autoplayTimer);
      return;
    }
    if (AUTOPLAY && booksReady) startAutoplay(AUTOPLAY_INTERVAL);
  });

  // ---------- Virtual Scroll Nav (DOWN adds only) ----------
  const VS = {
    THRESHOLD_PX: 20,
    COOLDOWN_MS: 120,
    MAX_STEPS_PER_SEC: 20,
    INERTIA_DECAY: 0.94,
    MIN_VELOCITY: 0.15,
    VELOCITY_GAIN: 0.9,
  };

  (function installVirtualScrollAdd(stageEl){
    let intent = 0;
    let lastFire = 0;
    let lastStepAt = 0;

    let touchActive = false;
    let lastY = 0;
    let lastT = 0;
    let velocity = 0;
    let rafId = null;

    const canFire = () => {
      if (!booksReady) return false;
      const now = performance.now();
      if (now - lastFire < VS.COOLDOWN_MS) return false;
      const minGap = 1000 / VS.MAX_STEPS_PER_SEC;
      if (now - lastStepAt < minGap) return false;
      return true;
    };

    const fireAdd = () => {
      if (!canFire()) return;
      addBook({ animateIn: true, dir: 0, intro: false, delay: 0 });
      const now = performance.now();
      lastFire = now;
      lastStepAt = now;
    };

    const consumeIntent = () => {
      while (intent >= VS.THRESHOLD_PX && canFire()) {
        fireAdd();
        intent -= VS.THRESHOLD_PX;
      }
      if (intent < 0) intent *= 0.5;
    };

    const addDelta = (deltaY) => {
      intent += deltaY;
      consumeIntent();
    };

    function stopInertia(){
      if (rafId != null) cancelAnimationFrame(rafId);
      rafId = null;
    }

    function startInertia(){
      stopInertia();
      let v = velocity * VS.VELOCITY_GAIN;

      const tick = () => {
        if (Math.abs(v) < VS.MIN_VELOCITY) { rafId = null; return; }
        const dt = 16;
        const delta = v * dt * 10;
        if (delta > 0) addDelta(delta);
        v *= VS.INERTIA_DECAY;
        rafId = requestAnimationFrame(tick);
      };

      rafId = requestAnimationFrame(tick);
    }

    const onWheel = (e) => {
      e.preventDefault();
      if (e.deltaY > 0) {
        noteUserInput();
        addDelta(e.deltaY);
      }
    };

    const onTouchStart = (e) => {
      if (!e.touches || e.touches.length !== 1) return;
      noteUserInput();
      touchActive = true;
      stopInertia();
      lastY = e.touches[0].clientY;
      lastT = performance.now();
      velocity = 0;
    };

    const onTouchMove = (e) => {
      if (!touchActive || !e.touches || e.touches.length !== 1) return;
      e.preventDefault();
      noteUserInput();

      const now = performance.now();
      const y = e.touches[0].clientY;

      const dy = lastY - y;
      const dt = Math.max(1, now - lastT);

      const v = dy / dt;
      velocity = velocity * 0.7 + v * 0.3;

      if (dy > 0) addDelta(dy);

      lastY = y;
      lastT = now;
    };

    const onTouchEnd = () => {
      if (!touchActive) return;
      touchActive = false;
      startInertia();
    };

    stageEl.addEventListener("wheel", onWheel, { passive: false });
    stageEl.addEventListener("touchstart", onTouchStart, { passive: false });
    stageEl.addEventListener("touchmove", onTouchMove, { passive: false });
    stageEl.addEventListener("touchend", onTouchEnd, { passive: false });
    stageEl.addEventListener("touchcancel", onTouchEnd, { passive: false });
  })(stage);

  // ---------- Resize ----------
  let resizeRAF = null;
  function onResize(){
    cancelAnimationFrame(resizeRAF);
    resizeRAF = requestAnimationFrame(() => {
      setViewportUnit();
      setGlobalWidthVar();
    });
  }
  window.addEventListener("resize", onResize);
  window.addEventListener("orientationchange", onResize);
  window.addEventListener("pageshow", onResize);

  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", onResize);
    window.visualViewport.addEventListener("scroll", onResize);
  }

  loadCovers()
    .then(() => onResize())
    .catch(err => console.error(err));
})();
  </script>
</body>
</html>
